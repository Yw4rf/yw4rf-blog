---
import Head from '../components/Head.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { config_site } from '../utils/config-adapter';
import '../styles/global.styl'; 
import '../styles/layouts/ArchivesLayout.styl'; 
import dayjs from 'dayjs';

import { Image } from "astro:assets";
import GifBlog from "../images/gif/blog-section2.gif";
import Button88x31 from '../components/others/88x31.astro'

interface Props {
  pageTitle: string;  
  description: string;
  posts: any[]; 
  totalPostsCount: number;
  noindex?: boolean;
}


const {
  pageTitle,
  description,
  posts, 
  totalPostsCount,
  noindex = true 
} = Astro.props;

// æŒ‰å¹´æœˆåˆ†ç»„ - This logic now uses the 'posts' prop
const archivesByYearMonth: Record<number, Record<number, any[]>> = {};
posts.forEach((post: any) => {
  if (!post.data.date) return;
  const date = dayjs(post.data.date);
  const year = date.year();
  const month = date.month() + 1; // dayjs æœˆä»½ä»Ž 0 å¼€å§‹
  if (!archivesByYearMonth[year]) {
    archivesByYearMonth[year] = {};
  }
  if (!archivesByYearMonth[year][month]) {
    archivesByYearMonth[year][month] = [];
  }
  archivesByYearMonth[year][month].push(post);
});

// æŒ‰å¹´ä»½é™åºæŽ’åº - 
const sortedYears = Object.keys(archivesByYearMonth)
  .map(Number)
  .sort((a: number, b: number) => b - a);
---
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
<!DOCTYPE html>
<html lang={config_site.lang}>
  <Head
    title={pageTitle}
    description={description}
    author={config_site.author}
    url={config_site.url + '/archives/'}
    canonical={config_site.url + '/archives/'}
    noindex={noindex}
  >
    {/* Allow passing additional head elements if needed */}
    <slot name="head" />
  </Head>
  <body>
    <Header />
    <main class="archives-container">
      <div class="page-header">
        {/* Use a more generic title prop for the H1, description prop for P */}
        <h1 class="page-title">My {pageTitle.split(' | ')[0]}</h1>
      <!--   <p class="page-description">Sharing insights on cybersecurity and tech ({totalPostsCount} Postsï¼‰</p> --> </div>

      
      <div class="timeline-container">
  {sortedYears.length > 0 ? (
    sortedYears.map(year => (
      <div class="year-section">
        {Object.keys(archivesByYearMonth[year])
          .map(Number)
          .sort((a, b) => b - a) 
          .map(month => (
            <div class="month">
              <ul class="post-list">
                {archivesByYearMonth[year][month].map(post => (
                  <li class="post-item">
                    <div class="post-entry"> 
                      <div class="post-content">
                        
                        {/* Fecha arriba, como en el estilo deseado */}
                        <span class="post-date-top">
                          <span class="date-icon">ðŸ•’</span> 
                          {dayjs(post.data.date).format('MMMM DD, YYYY')}
                        </span>

                        <span class="post-title"><a href={`/posts/${post.data.abbrlink}/`}>{post.data.title}</a></span>
                             
                      <div class="post-metadata">
  <div class="tags-container">
  {/* Contenedor de etiquetas */}
  {post.data.tags && post.data.tags.length > 0 && (
    <div class="post-tags-container">
      <div class="post-tag-title">ðŸ·ï¸ tags:  
      {post.data.tags.slice(0, 14).map((tag: string) => (
        <span class="post-tag">
          <a href={`/tags/${encodeURIComponent(tag)}/`} class="anchore-tag">#{tag}</a>
        </span>
      ))}
      </div>
    </div>
  )}
  </div>
  <div class="tags-mobile-container">
   {/* Contenedor de etiquetas */}
  {post.data.tags && post.data.tags.length > 0 && (
    <div class="post-tags-container">
      <div class="post-tag-title">ðŸ·ï¸   
      {post.data.tags.slice(0, 14).map((tag: string) => (
        <span class="post-tag">
          <a href={`/tags/${encodeURIComponent(tag)}/`} class="anchore-tag">#{tag}</a>
        </span>
      ))}
      </div>
    </div>
  )}                      
  </div> 
</div>
                        
                        {/* Â¡Â¡Â¡ESTO ES LO IMPORTANTE!!!: La descripciÃ³n como un bloque de texto separado */}
                        <span class="post-description-similar">{post.data.description || 'No hay descripciÃ³n disponible'}</span>
                        
                      </div>
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          ))}
      </div>
    ))
  ) : (
    <div class="no-posts">No posts</div>
  )}
</div>

      <div id="lazyload-observer" class="lazyload-observer">
        <div class="loading-spinner">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
        <div class="loading-text">Loading text...</div>
      </div>
      {/* Allow passing additional main content if needed */}
      <slot name="main" />
    </main>

    <script>
      // æ‡’åŠ è½½å®žçŽ° (This script is identical to the original page's script)
      document.addEventListener('DOMContentLoaded', () => {
        let visibleYears = 2;
        const yearSections = document.querySelectorAll('.year-section');
        const totalYears = yearSections.length;
        const lazyloadObserver = document.getElementById('lazyload-observer');

        const updateLoadingIndicator = (isLoading: boolean, isComplete: boolean) => {
          if (!lazyloadObserver) return;
          const loadingText = lazyloadObserver.querySelector('.loading-text') as HTMLElement;
          const loadingSpinner = lazyloadObserver.querySelector('.loading-spinner') as HTMLElement;
          if (isComplete) {
            if (loadingText) loadingText.textContent = 'All posts have been uploaded';
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            setTimeout(() => {
              if (lazyloadObserver) {
                (lazyloadObserver as HTMLElement).style.opacity = '0';
                setTimeout(() => {
                  if (lazyloadObserver) {
                    (lazyloadObserver as HTMLElement).style.display = 'none';
                  }
                }, 500);
              }
            }, 3000);
          } else {
            if (loadingText) loadingText.textContent = isLoading ? 'Loading posts...' : 'Scroll to load more posts';
          }
        };

        const showYearSection = (index: number) => {
          if (index >= 0 && index < totalYears && yearSections[index]) {
            const section = yearSections[index] as HTMLElement;
            section.style.display = 'block';
            section.style.opacity = '0';
            setTimeout(() => {
              section.style.opacity = '1';
              section.style.transform = 'translateY(0)';
            }, 50);
          }
        };        if (totalYears > 0) {
          for (let i = 0; i < totalYears; i++) {
            if (i < visibleYears) {
              showYearSection(i);
            } else {
              (yearSections[i] as HTMLElement).style.display = 'none';
            }
          }
          if (totalYears <= visibleYears && lazyloadObserver) {
            updateLoadingIndicator(false, true);
          }
        }

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting && visibleYears < totalYears) {
              updateLoadingIndicator(true, false);
              setTimeout(() => {
                showYearSection(visibleYears);
                visibleYears++;
                if (visibleYears >= totalYears) {
                  updateLoadingIndicator(false, true);
                } else {
                  updateLoadingIndicator(false, false);
                }
              }, 300);
            }
          });
        }, {
          rootMargin: '300px',
          threshold: 0.1
        });

        if (lazyloadObserver) {
          observer.observe(lazyloadObserver);
        } else {
          console.warn('Lazy loading indicator element not found');
        }

        window.addEventListener('error', (e) => {
          if (e.message.includes('lazyload') || e.message.includes('observer')) {
            console.error('Error in lazy loading function:', e);
          }
        });
      });
    </script>
  </body>
</html>