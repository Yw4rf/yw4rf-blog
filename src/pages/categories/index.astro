---
import { getCollection } from 'astro:content';
import { config_site } from '../../utils/config-adapter';
import { processFrontmatter } from '../../integrations/process-frontmatter';
import { extractFlatCategories, sortCategoriesByCount } from '../../utils/category-utils';
import CategoriesLayout from '../../layouts/CategoriesLayout.astro';
import TagsLayout from '../../layouts/TagsLayout.astro';
import Button88x31 from '../../components/others/88x31.astro'

// CATEGORIES
const allPosts = await getCollection('posts');
const processedPosts = await Promise.all(allPosts.map(post => processFrontmatter(post)));

// 获取所有分类并按文章数量排序
const categories = extractFlatCategories(processedPosts);
const sortedCategories = sortCategoriesByCount(categories);

// 页面标题
const pageTitle = 'Categories | ' + config_site.siteName;


// TAGS
const posts = await Promise.all(allPosts.map(post => processFrontmatter(post)));

// 提取所有标签并计算数量
const tagCounts: Record<string, number> = {};
posts.forEach(post => {
  const tags = post.data.tags || [];
  tags.forEach((tag: string) => {
    if (tag.trim()) {
      tagCounts[tag] = (tagCounts[tag] || 0) + 1;
    }
  });
});
// 转换为排序后的数组
const sortedTags = Object.entries(tagCounts)
  .sort(([, countA], [, countB]) => countB - countA) // 按数量降序排序
  .map(([tag, count]) => ({ tag, count }));
---
<CategoriesLayout 
  title={pageTitle}
  description="Browse all articles, indexed by topic."
  author={config_site.author || ''}
  url={config_site.url + '/categories/'}
  categories={sortedCategories}
  noIndex={false}
/>